name: Update Dependencies

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Setup Deno environment
        uses: denoland/setup-deno@v2

      - name: Check for outdated dependencies
        id: check
        run: |
          echo "Checking for outdated dependencies..."
          deno outdated || true
          
          # Check if there are updates available
          if deno outdated 2>&1 | grep -q "No outdated dependencies"; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi

      - name: Update dependencies
        if: steps.check.outputs.has_updates == 'true'
        run: |
          echo "Updating dependencies to latest semver-compatible versions..."
          deno update

      - name: Test build
        if: steps.check.outputs.has_updates == 'true'
        run: |
          echo "Testing if site builds successfully..."
          deno task build

      - name: Create Pull Request
        if: steps.check.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update Deno dependencies"
          title: "chore(deps): Update Deno dependencies"
          body: |
            ## Automated Dependency Update
            
            This PR updates Deno dependencies to their latest semver-compatible versions.
            
            ### Changes
            - Updated dependencies using `deno update`
            - Build test passed âœ…
            
            ### Next Steps
            - Review the changes in `deno.json`
            - Check the build output
            - Merge if everything looks good
            
            ---
            *Generated by [update-dependencies.yml](.github/workflows/update-dependencies.yml)*
          branch: deps/update-deno-dependencies
          delete-branch: true
          labels: |
            dependencies
            automated
